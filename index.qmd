---
title: "No Data, No Worries : Fabricatr"
# format: revealjs
author:
  - name: Neil Shephard
    orcid: 0000-0001-8301-6857
    email: n.shephard@sheffield.ac.uk
    affiliations: Research Software Engineer, Department of Computer Science, University of Sheffield
from: markdown+emoji
format:
  clean-revealjs:
    incremental: false
    slide-number: true
    show-slide-number: speaker
    auto-stretch: false
    chalkboard: true
    # embed-resources: true
    # standalone: true
    header: Quarto RevealJS Template
revealjs-plugins:
  - confetti
footer: "**Slides** : [**ns-rse.github.io/sheffieldr-fabricatr-20240621**](https://ns-rse.github.io/sheffieldr-fabricatr-20240621)"
project:
  preview:
    port: 7864
    host: localhost
    watch-inputs: true
filters:
  - openlinksinnewpage
  - reveal-header
---

## Scan This

{{< qrcode <https://ns-rse.github.io/sheffieldr-fabricatr-20240621> qr1 width=400 height=400 >}}

[ns-rse.github.io/sheffieldr-fabricatr-20240621](https://ns-rse.github.io/sheffieldr-fabricatr-20240621)

## Motivation

:::: {.columns}

::: {.column width="30%"}

+ Rarely work on my own data.
+ Literate, reproducible workflow
  + [Org-Babel][org-babel]
  + [RMarkdown][rmarkdown]
  + [Quarto][quarto].
+ Scripts to clean, summarise, plot and analyse data.

:::

::: {.column width="70%"}

![The Turing Way project illustration by Scriberia. Used under a CC-BY 4.0 licence. DOI:
[10.5281/zenodo.3332807](https://doi.org/10.5281/zenodo.3332807)](https://the-turing-way.netlify.app/_images/reproducibility.jpg)
:::
::::

::: {.notes}
Speaker Notes can be added to each slide. **Formatting** can be used here too.
::
:
## Problem

:::: {.columns}

::: {.column width="30%"}

+ Rarely is full data set available!

:::

::: {.column width="70%"}

![The Turing Way project illustration by Scriberia. Used under a CC-BY 4.0 licence. DOI: [10.5281/zenodo.3332807](https://doi.org/10.5281/zenodo.3332807)](https://the-turing-way.netlify.app/_images/research-cycle.svg)

:::
::::

::: {.notes}
Speaker Notes can be added to each slide. **Formatting** can be used here too.
:::

## Solution

+ Database schema/dictionary?

. . .

+ Simulate data!

## Fabricatr

+ [fabricatr][fabricatr] - _Imagine Your Data Before You Collect It_

:::: {.columns}

::: {.column width="50%"}

```r
install.packages(c("fabricatr", "tidyverse"))
library(correlate)
library(dplyr)
library(fabricatr)
library(tidyr)
library(visdat)
library(nanair)

set.seed(55138)
```

:::

::: {.column width="50%"}

+ Binary variables
+ Categorical/factors
+ Continuous
+ Time-Series
+ Correlated
+ Intra-Class Correlation (ICC)
:::
::::

::: {.notes}
Speaker Notes can be added to each slide. **Formatting** can be used here too.
:::

## Basic Example

:::: {.columns}

::: {.column width="50%"}

+ 100 observations.
+ Binary : [`draw_binary()`][draw-discrete].
+ Binomial : [`draw_binomial()`][draw-discrete].
+ Continuous (0-1) : [`runif()`][runif].
+ Random Normal (mean = 38, sd = 16) : [`rnorm()`][rnorm].

:::
::: {.column width="50%"}

```{r}
#| label: fabricatr-basic
#| warning: false
#| eval: true
#| echo: true
dummy_df <- fabricatr::fabricate(
    N = 100,
    binary = fabricatr::draw_binary(
        N,
        prob = runif(N)
        ),
    binomial = fabricatr::draw_binomial(
        prob = runif(N),
        trials = 2
        ),
    uniform = runif(N),
    random_normal = rnorm(N, 38, 16)
)
dummy_df |> head()

```

:::

::::

::: {.notes}
[R](https://www.r-project.org/) code can be embeded and executed to produce tables and figures.
:::

## Basic Example - Summary


:::: {.columns}

::: {.column width="50%"}

```{r}
#| label: fabricatr-basic-summary
#| warning: false
#| eval: true
#| echo: false
library(gtsummary)

gtsummary::tbl_summary(
    dummy_df,
    include = c(binary,
                binomial,
                uniform,
                random_normal))

```

:::
::: {.column width="50%"}

```{r}
#| label: fig-fabricatr-basic-histogram
#| fig-cap: Random Normal variable.
#| warning: false
#| eval: true
#| echo: false
library(ggplot2)

ggplot(dummy_df, aes(random_normal)) +
   geom_histogram()

ggplot(dummy_df, aes(binary)) +
   geom_bar() +
   ggtitle("Random Normal Variable")
```

```{r}
#| label: fig-fabricatr-basic-bar
#| fig-cap: Binary variable.
#| warning: false
#| eval: true
#| echo: false

ggplot(dummy_df, aes(binary, fill = binary)) +
   geom_bar() +
   ggtitle("Binary Variable")
```


:::

::::


## Categorical Variables

:::: {.columns}

::: {.column width="50%"}

+ 100 observations
+ Random Normal (mean = 0, sd = 1) : [`rnorm()`][rnorm]
+ Categorise using [`draw_ordered()`][draw-discrete] and setting `breaks`.
+ Label variables with `break_labels`

:::
::: {.column width="50%"}

```{r}
#| label: fabricatr-categorical
#| warning: false
#| eval: true
#| echo: true
cat_df <- fabricatr::fabricate(
    N = 100,
    x = rnorm(N),
    ordered = fabricatr::draw_ordered(
        x,
        breaks = c(-Inf,
                   -1,
                   -0.5,
                   0,
                   0.5,
                   1,
                   Inf),
        break_labels = c("Group 1",
                         "Group 2",
                         "Group 3",
                         "Group 4",
                         "Group 5",
                         "Group 6")
    )
)
```

:::

::::

::: {.notes}
[R](https://www.r-project.org/) code can be embeded and executed to produce tables and figures.
:::

## Categorical Variables - Summary


:::: {.columns}

::: {.column width="50%"}

```{r}
#| label: fabricatr-categorical-summary
#| fig-cap: Categorical variable with six levels.
#| warning: false
#| eval: true
#| echo: false
gtsummary::tbl_summary(
    cat_df,
    include = c(ordered)
)

```

:::
::: {.column width="50%"}

```{r}
#| label: fig-fabricatr-categorical-bar
#| warning: false
#| eval: true
#| echo: false
ggplot(cat_df, aes(ordered, fill=ordered)) +
    geom_bar()

```

:::

::::

::: {.notes}
[R](https://www.r-project.org/** code can be embeded and executed to produce tables and figures.
:::


## Correlated Continuous Variables

**EXPERIMENTAL**

:::: {.columns}

::: {.column width="50%"}

+ 100 observations
+ Random Normal  `y` (mean = 38, sd = 16) :  using [`rnorm()`][rnorm]
+ Random normal `a` (mean = 78, sd = 14) : [`rnorm()`][rnorm] rank correlation with `y` of `0.8` using [`correlate`][correlate]
+ Random normal `b` (mean = 46, sd = 18) : [`rnorm()`][rnorm] rank correlation with `y` of `-0.4` using [`correlate`][correlate]

:::
::: {.column width="50%"}

```{r}
#| label: fabricatr-correlated-continuous
#| warning: false
#| eval: true
#| echo: true
corr_df <- fabricatr::fabricate(
    N = 100,
    y = rnorm(N, mean = 64, sd = 11),
    a = fabricatr::correlate(given = y,
                             rho = 0.8,
                             rnorm,
                             mean = 78,
                             sd = 14),
    b = fabricatr::correlate(given = y,
                             rho = -0.4,
                             rnorm,
                             mean = 46,
                             sd = 18)

)
```

:::

::::

::: {.notes}
[R](https://www.r-project.org/) code can be embeded and executed to produce tables and figures.
:::


## Correlated Continuous Variables - Summary

:::: {.columns}

::: {.column width="50%"}

```{r}
#| label: fabricatr-correlated-continuous-summary
#| warning: false
#| eval: true
#| echo: false
gtsummary::tbl_summary(
    corr_df,
    include = c(y, a, b)
    )

```

:::
::: {.column width="50%"}

```{r}
#| label: fabricatr-correlated-continuous-heatmap
#| warning: false
#| eval: true
#| echo: false
cov_tibble <- corr_df |>
    dplyr::select(y, a, b) |>
    corrr::correlate() |>
    tidyr::pivot_longer(-term, names_to="var", values_to="correlation")
unique_vars <- unique(cov_tibble$term)
cov_tibble <- cov_tibble |>
    dplyr::mutate(
        term = factor(term, levels = unique_vars),
        var = factor(var, levels = rev(unique_vars)))
ggplot2::ggplot(cov_tibble, aes(term, var)) +
  geom_tile(aes(fill = correlation)) +
  geom_text(aes(label = round(correlation, 3))) +
  labs(x = element_blank(),
       y = element_blank(),
       fill = "Correlation",
       title = "Correlation in Simulated Data") +
  scale_fill_gradient2(
    high = "firebrick2",
    mid = "white",
    low = "dodgerblue4"
  )
```

:::

::::

::: {.notes}
[R](https://www.r-project.org/) code can be embeded and executed to produce tables and figures.
:::

## Correlated Discrete Variables

**EXPERIMENTAL**

:::: {.columns}

::: {.column width="50%"}

+ 100 observations
+ Binomial  `q1` (prob = 0.38, trials = 10) :  using [`draw_binomial()`][draw_discrete]
+ Binomial `q1` (prob = 0.63, trials = 5) : [`draw_binomial()`][draw_discrete] rank correlation with `q1` of `0.74`
  using [`correlate`][correlate]
+ Binomial `q3` (prob = 0.79, trials = 5) : [`draw_binomial()`][draw_discrete] rank correlation with `q2` of `-0.89` using [`correlate`][correlate]

:::
::: {.column width="50%"}

```{r}
#| label: fabricatr-correlated-discrete
#| warning: false
#| eval: true
#| echo: true
corr_discrete_df <- fabricatr::fabricate(
    N = 100,
    q1 = fabricatr::draw_binomial(prob = 0.38, trials = 10, N = N),
    q2 = fabricatr::correlate(given = q1,
                             rho = 0.74,
                             fabricatr::draw_binomial,
                             prob = 0.63,
                             trials = 10),
    q3 = fabricatr::correlate(given = q2,
                             rho = -0.89,
                             fabricatr::draw_binomial,
                             prob = 0.79,
                             trials = 10)
)
```

:::

::::

::: {.notes}
[R](https://www.r-project.org/) code can be embeded and executed to produce tables and figures.
:::


## Correlated Discrete Variables - Summary {.scrollable}

:::: {.columns}

::: {.column width="50%"}

```{r}
#| label: fabricatr-correlated-discrete-summary
#| warning: false
#| eval: true
#| echo: false
gtsummary::tbl_summary(
    corr_discrete_df,
    include = c(q1, q2, q3)
    )

```

:::
::: {.column width="50%"}

```{r}
#| label: fabricatr-correlated-discrete-heatmap
#| warning: false
#| eval: true
#| echo: false
cov_tibble <- corr_discrete_df |>
    dplyr::select(q1, q2, q3) |>
    corrr::correlate() |>
    tidyr::pivot_longer(-term, names_to="var", values_to="correlation")
unique_vars <- unique(cov_tibble$term)
cov_tibble <- cov_tibble |>
    dplyr::mutate(
        term = factor(term, levels = unique_vars),
        var = factor(var, levels = rev(unique_vars)))
ggplot2::ggplot(cov_tibble, aes(term, var)) +
  geom_tile(aes(fill = correlation)) +
  geom_text(aes(label = round(correlation, 3))) +
  labs(x = element_blank(),
       y = element_blank(),
       fill = "Correlation",
       title = "Correlation in Simulated Data") +
  scale_fill_gradient2(
    high = "firebrick2",
    mid = "white",
    low = "dodgerblue4"
  )
```

:::

::::

::: {.notes}
[R](https://www.r-project.org/) code can be embeded and executed to produce tables and figures.
:::

## Intra Class Correlation (ICC)

:::: {.columns}

::: {.column width="50%"}

+ Nested study design (e.g. schools, counties)

:::
::: {.column width="50%"}

```{r}
#| label: fabricatr-icc
#| warning: false
#| eval: true
#| echo: true
```

:::

::::

## Intra Class Correlation (ICC) - Summary

:::: {.columns}

::: {.column width="50%"}

```{r}
#| label: fabricatr-icc-summary
#| warning: false
#| eval: true
#| echo: false

```

:::
::: {.column width="50%"}

```{r}
#| label: fabricatr-icc-heatmap
#| warning: false
#| eval: true
#| echo: false

```

:::

::::

::: {.notes}
[R](https://www.r-project.org/) code can be embeded and executed to produce tables and figures.
:::

## Summary

+ [fabricatr][fabricatr] powerful but _easy_ to use.
+ Simulate data and setup analytical workflow.
+ Not useful for _cleaning/tidying_ real data (~80% of work!).
+ Need good database schema/data dictionary



[correlate]: https://declaredesign.org/r/fabricatr/reference/correlate.html
[draw-discrete]: https://declaredesign.org/r/fabricatr/reference/draw_discrete.html
[fabricatr]: https://declaredesign.org/r/fabricatr/
[org-babel]: https://orgmode.org/worg/org-contrib/babel/
[rmarkdown]: https://bookdown.org/yihui/rmarkdown/
[quarto]: https://quarto.org
[rnorm]: https://rdrr.io/r/stats/Normal.html
[runif]: https://rdrr.io/r/stats/Uniform.html
